export default async function handler(e,t){const{userId:a,type:s="full",isCircular:r=!1,size:o=420,format:i="Png",responseType:n="image"}=e.query;if(!a)return t.status(400).json({error:"User ID not specified!"});const u={full:"avatar",bust:"avatar-bust",headshot:"avatar-headshot",face:"avatar-headshot",avatar:"avatar","avatar-bust":"avatar-bust","avatar-headshot":"avatar-headshot"},l=`https://thumbnails.roblox.com/v1/users/${u[s]}?userIds=${a}&size=${o}x${o}&format=${i}&isCircular=${r}`,d=`https://users.roblox.com/v1/users/${a}`;try{const e=fetch(d);let a,c,f,m=0;for(;m<=2&&(f=await fetch(l),f.ok)&&(c=await f.json(),a=c?.data?.[0],"Completed"!==a?.state||!a?.imageUrl);)m<2&&await new Promise(e=>setTimeout(e,350)),m++;if(!f?.ok)return t.status(f.status).json({error:"Roblox API error, because...I'm not sure???",status:f.status});if(!a?.imageUrl){const e=a?.state??"Unknown, user may not exist?";return t.status(202).json({error:"Roblox API refusal, user may contain deleted items",state:e,attempts:m})}if("image"==n){const e=await fetch(a.imageUrl),s=e.headers.get("content-type"),r=await e.arrayBuffer();return t.setHeader("Cache-Control","public, max-age=300, stale-while-revalidate=60"),t.setHeader("Content-Type",s),t.setHeader("Access-Control-Allow-Origin","*"),t.status(200).send(Buffer.from(r))}if("json"==n){const n=await e;if(!n.ok)return t.status(404).json({error:"Roblox API, user info not found"});const l=await n.json();return t.setHeader("Access-Control-Allow-Origin","*"),t.status(200).json({userId:l.id,username:l.name,isBanned:l.isBanned,profileInfo:{created:l.created,hasVerifiedBadge:l.hasVerifiedBadge,displayName:l.displayName,description:l.description},avatarThumbnail:{imageUrl:a.imageUrl,state:a.state,type:s,typeRaw:u[s],size:o,isCircular:r,format:i}})}t.status(400).json({error:"Invalid response type"})}catch(e){t.status(500).json({error:"Failed to fetch from Roblox",details:e.message})}}