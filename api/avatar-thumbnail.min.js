export default async function handler(e,t){const{userId:r,type:s="avatar",isCircular:a=!1,size:o=420,format:i="Png",responseType:n="image",maxRetries:u=2,retryDelayMs:l=350}=e.query;if(!r)return t.status(400).json({error:"User ID not specified!"});const d=`https://thumbnails.roblox.com/v1/users/${s}?userIds=${r}&size=${o}x${o}&format=${i}&isCircular=${a}`,m=`https://users.roblox.com/v1/users/${r}`;try{const e=fetch(m);let r,c,f,p=0;for(;p<=Number(u)&&(f=await fetch(d),f.ok)&&(c=await f.json(),r=c?.data?.[0],"Completed"!==r?.state||!r?.imageUrl);)p<Number(u)&&await new Promise(e=>setTimeout(e,Number(l))),p++;if(!f?.ok)return t.status(502).json({error:"Roblox thumbnails API error",status:f.status});if(!r?.imageUrl){const e=r?.state??"Unknown";return t.status(202).json({error:"Thumbnail not ready",state:e,retryAfterMs:Number(l),attempts:p})}if("image"==n){const e=await fetch(r.imageUrl),s=e.headers.get("content-type"),a=await e.arrayBuffer();return t.setHeader("Cache-Control","public, max-age=300, stale-while-revalidate=60"),t.setHeader("Content-Type",s),t.setHeader("Access-Control-Allow-Origin","*"),t.status(200).send(Buffer.from(a))}if("json"==n){const n=await e;if(!n.ok)return t.status(404).json({error:"User info not found"});const u=await n.json();return t.setHeader("Access-Control-Allow-Origin","*"),t.status(200).json({userId:u.id,username:u.name,isBanned:u.isBanned,profileInfo:{created:u.created,hasVerifiedBadge:u.hasVerifiedBadge,displayName:u.displayName,description:u.description},avatarThumbnail:{imageUrl:r.imageUrl,state:r.state,type:s,size:o,isCircular:a,format:i}})}t.status(400).json({error:"Invalid response type"})}catch(e){t.status(500).json({error:"Failed to fetch from Roblox",details:e.message})}}