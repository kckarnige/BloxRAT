export default async function handler(e,t){const{userId:a,type:r="full",isCircular:s=!1,size:o=420,format:i="Png",responseType:n="image",maxRetries:u=2,retryDelayMs:l=350}=e.query;if(!a)return t.status(400).json({error:"User ID not specified!"});const d={full:"avatar",bust:"avatar-bust",headshot:"avatar-headshot",avatar:"avatar","avatar-bust":"avatar-bust","avatar-headshot":"avatar-headshot"},m=`https://thumbnails.roblox.com/v1/users/${d[r]}?userIds=${a}&size=${o}x${o}&format=${i}&isCircular=${s}`,c=`https://users.roblox.com/v1/users/${a}`;try{const e=fetch(c);let a,f,h,p=0;for(;p<=Number(u)&&(h=await fetch(m),h.ok)&&(f=await h.json(),a=f?.data?.[0],"Completed"!==a?.state||!a?.imageUrl);)p<Number(u)&&await new Promise(e=>setTimeout(e,Number(l))),p++;if(!h?.ok)return t.status(502).json({error:"Roblox thumbnails API error",status:h.status});if(!a?.imageUrl){const e=a?.state??"Unknown";return t.status(202).json({error:"Thumbnail not ready",state:e,retryAfterMs:Number(l),attempts:p})}if("image"==n){const e=await fetch(a.imageUrl),r=e.headers.get("content-type"),s=await e.arrayBuffer();return t.setHeader("Cache-Control","public, max-age=300, stale-while-revalidate=60"),t.setHeader("Content-Type",r),t.setHeader("Access-Control-Allow-Origin","*"),t.status(200).send(Buffer.from(s))}if("json"==n){const n=await e;if(!n.ok)return t.status(404).json({error:"User info not found"});const u=await n.json();return t.setHeader("Access-Control-Allow-Origin","*"),t.status(200).json({userId:u.id,username:u.name,isBanned:u.isBanned,profileInfo:{created:u.created,hasVerifiedBadge:u.hasVerifiedBadge,displayName:u.displayName,description:u.description},avatarThumbnail:{imageUrl:a.imageUrl,state:a.state,type:r,typeRaw:d[r],size:o,isCircular:s,format:i}})}t.status(400).json({error:"Invalid response type"})}catch(e){t.status(500).json({error:"Failed to fetch from Roblox",details:e.message})}}